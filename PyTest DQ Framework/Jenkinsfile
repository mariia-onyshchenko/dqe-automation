pipeline {
    agent any

    environment {
        // Keep credentials masked
        DB_USER = credentials('POSTGRES_USER_CRED_ID')
        DB_PASSWORD = credentials('POSTGRES_PASS_CRED_ID')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: 'main']],
                    userRemoteConfigs: [[url: 'https://github.com/mariia-onyshchenko/dqe-automation.git']]
                ])
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('PyTest DQ Framework') {
                    sh '''
                        python3 -m venv venv
                        ./venv/bin/pip install --upgrade pip
                        ./venv/bin/pip install -r requirements.txt
                    '''
                }
            }
        }

        stage('Run Tests') {
            steps {
                // Run pytest from workspace root, so parquet_data is accessible
                sh '''
                    "PyTest DQ Framework/venv/bin/pytest" tests -m "parquet_data" \\
                        --db_host=postgres \\
                        --db_port=5432 \\
                        --db_name=mydatabase \\
                        --db_user=$DB_USER \\
                        --db_password=$DB_PASSWORD \\
                        --html="PyTest DQ Framework/html_report/report.html"
                '''
            }
        }

        stage('Archive Test Report') {
            steps {
                archiveArtifacts artifacts: 'PyTest DQ Framework/html_report/report.html', allowEmptyArchive: true
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished.'
        }
        failure {
            echo 'Pipeline failed. Check the HTML report for details.'
        }
    }
}
